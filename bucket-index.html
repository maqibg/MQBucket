<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MQBucket - Scoop Bucket çŠ¶æ€çœ‹æ¿</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Consolas,Monaco,monospace;background:#1e1e1e;color:#d4d4d4;line-height:1.6;font-size:16px}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
.header-left h1{color:#4ec9b0;font-size:36px;margin-bottom:8px}
.header-left .meta{color:#858585;font-size:15px}
.btn-github{background:#238636;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;text-decoration:none;display:inline-block;transition:background .2s}
.btn-github:hover{background:#2ea043}
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px}
.card{background:#252526;border:1px solid #3e3e42;border-radius:6px;padding:20px;text-align:center}
.card .label{color:#858585;font-size:14px;text-transform:uppercase;margin-bottom:8px}
.card .value{font-size:40px;font-weight:bold}
.card.latest .value{color:#4ec9b0}
.card.outdated .value{color:#dcdcaa}
.card.failed .value{color:#f48771}
.toolbar{background:#252526;border:1px solid #3e3e42;border-radius:6px;padding:15px;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.toolbar input{background:#1e1e1e;border:1px solid #3e3e42;color:#d4d4d4;padding:8px 12px;border-radius:4px;font-size:13px;flex:1;min-width:200px}
.toolbar select{background:#1e1e1e;border:1px solid #3e3e42;color:#d4d4d4;padding:8px 12px;border-radius:4px;font-size:13px}
.toolbar button{background:#0e639c;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;transition:background .2s}
.toolbar button:hover{background:#1177bb}
.table-container{background:#252526;border:1px solid #3e3e42;border-radius:6px;overflow:hidden}
table{width:100%;border-collapse:collapse}
thead{background:#2d2d30;position:sticky;top:0;z-index:10}
th{padding:12px;text-align:left;font-size:14px;color:#858585;text-transform:uppercase;border-bottom:1px solid #3e3e42;cursor:pointer;user-select:none}
th:hover{background:#3e3e42}
th.sortable::after{content:'â‡…';margin-left:5px;opacity:.3}
th.sort-asc::after{content:'â†‘';opacity:1}
th.sort-desc::after{content:'â†“';opacity:1}
td{padding:12px;border-bottom:1px solid #3e3e42;font-size:15px}
tr:hover{background:#2d2d30}
.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:bold}
.status-latest{background:#2d5a3a;color:#4ec9b0}
.status-outdated{background:#5a4f2d;color:#dcdcaa}
.status-failed{background:#5a2d2d;color:#f48771}
.version{font-family:monospace;color:#ce9178}
.actions{display:flex;gap:8px}
.btn-sm{background:#3e3e42;color:#d4d4d4;border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:11px;transition:background .2s}
.btn-sm:hover{background:#4e4e52}
.empty-state{text-align:center;padding:60px 20px;color:#858585}
.empty-state h2{color:#d4d4d4;margin-bottom:10px}
.toast{position:fixed;top:20px;right:20px;background:#4ec9b0;color:#1e1e1e;padding:12px 18px;border-radius:6px;font-size:13px;opacity:0;transition:opacity .3s;pointer-events:none;z-index:1000}
.toast.show{opacity:1}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:2000}
.modal.show{display:flex}
.modal-content{background:#252526;border:1px solid #3e3e42;border-radius:8px;padding:30px;max-width:600px;width:90%}
.modal-content h2{color:#4ec9b0;margin-bottom:15px;font-size:20px}
.modal-content pre{background:#1e1e1e;padding:15px;border-radius:4px;overflow-x:auto;margin:15px 0;font-size:13px;color:#ce9178}
.modal-content button{margin-top:15px}
.loading{text-align:center;padding:40px;color:#858585}
.detail-row{background:#1e1e1e;display:none}
.detail-row.show{display:table-row}
.detail-content{padding:20px;font-size:12px;color:#858585}
.detail-content pre{background:#252526;padding:12px;border-radius:4px;overflow-x:auto;margin-top:10px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="header-left">
<h1>MQBucket - Scoop Bucket çŠ¶æ€çœ‹æ¿</h1>
<div class="meta">
<span id="lastUpdate">åŠ è½½ä¸­...</span>
<span style="margin:0 10px">|</span>
<span>æ•°æ®æº: <strong id="dataSource">CI</strong></span>
</div>
</div>
<a href="https://github.com/maqibg/MQBucket" target="_blank" class="btn-github">ğŸ  è®¿é—® Bucket ä¸»é¡µ</a>
</div>

<div class="summary">
<div class="card latest">
<div class="label">æœ€æ–°</div>
<div class="value" id="summaryLatest">-</div>
</div>
<div class="card outdated">
<div class="label">éœ€æ›´æ–°</div>
<div class="value" id="summaryOutdated">-</div>
</div>
<div class="card failed">
<div class="label">æ£€æµ‹å¤±è´¥</div>
<div class="value" id="summaryFailed">-</div>
</div>
<div class="card">
<div class="label">æ€»è®¡</div>
<div class="value" id="summaryTotal">-</div>
</div>
</div>

<div class="toolbar">
<input type="text" id="searchInput" placeholder="æœç´¢åº”ç”¨åç§°æˆ–æè¿°...">
<select id="statusFilter">
<option value="all">å…¨éƒ¨çŠ¶æ€</option>
<option value="latest">æœ€æ–°</option>
<option value="outdated">éœ€æ›´æ–°</option>
<option value="failed">å¤±è´¥</option>
</select>
<select id="sortBy">
<option value="name">æŒ‰åç§°</option>
<option value="status">æŒ‰çŠ¶æ€</option>
<option value="duration">æŒ‰è€—æ—¶</option>
</select>
<button onclick="reloadData()">ğŸ”„ é‡æ–°åŠ è½½æ•°æ®</button>
<button onclick="showCheckHelp()">ğŸ” æ‰‹åŠ¨æ£€æµ‹ç‰ˆæœ¬</button>
</div>

<div class="table-container">
<table id="appTable">
<thead>
<tr>
<th class="sortable" data-sort="name">åº”ç”¨åç§°</th>
<th class="sortable" data-sort="status">çŠ¶æ€</th>
<th class="sortable" data-sort="bucketVersion">Bucket ç‰ˆæœ¬</th>
<th class="sortable" data-sort="latestVersion">æœ€æ–°ç‰ˆæœ¬</th>
<th class="sortable" data-sort="duration">è€—æ—¶</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="appTableBody">
<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
</tbody>
</table>
</div>
</div>

<div class="toast" id="toast"></div>

<div class="modal" id="checkModal">
<div class="modal-content">
<h2>ğŸ” æ‰‹åŠ¨æ£€æµ‹ç‰ˆæœ¬</h2>
<p>è¦æ‰‹åŠ¨æ£€æµ‹æ‰€æœ‰åº”ç”¨çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre>pwsh -File scripts/generate-status.ps1 -Token "your_token"</pre>
<p style="margin-top:15px;color:#858585;font-size:13px">
æ£€æµ‹å®Œæˆåï¼Œç‚¹å‡»"é‡æ–°åŠ è½½æ•°æ®"æŒ‰é’®åˆ·æ–°é¡µé¢ã€‚<br>
æ³¨æ„ï¼šæ£€æµ‹ 36 ä¸ªåº”ç”¨çº¦éœ€ 72 ç§’ï¼ˆæ¯ä¸ªåº”ç”¨é—´éš” 2 ç§’ï¼‰ã€‚<br>
<strong>å»ºè®®ä½¿ç”¨ Token é¿å… API é™æµï¼ˆ60æ¬¡/å°æ—¶ â†’ 5000æ¬¡/å°æ—¶ï¼‰</strong>
</p>
<button class="btn-sm" onclick="closeModal()">å…³é—­</button>
</div>
</div>

<script>
let statusData = null;
let filteredApps = [];
let currentSort = { key: 'name', order: 'asc' };

async function loadStatus() {
  try {
    const response = await fetch('./status.json');
    if (!response.ok) throw new Error('æ— æ³•åŠ è½½ status.json');
    statusData = await response.json();
    updateUI();
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error);
    document.getElementById('appTableBody').innerHTML =
      '<tr><td colspan="6" class="empty-state"><h2>æ— æ³•åŠ è½½æ•°æ®</h2><p>è¯·ç¡®ä¿ status.json æ–‡ä»¶å­˜åœ¨</p></td></tr>';
  }
}

function updateUI() {
  if (!statusData) return;

  document.getElementById('lastUpdate').textContent =
    `æœ€åæ›´æ–°: ${new Date(statusData.generatedAt).toLocaleString('zh-CN')}`;
  document.getElementById('dataSource').textContent =
    statusData.source === 'ci' ? 'CI (GitHub Actions)' : 'Local';

  document.getElementById('summaryLatest').textContent = statusData.summary.latest;
  document.getElementById('summaryOutdated').textContent = statusData.summary.outdated;
  document.getElementById('summaryFailed').textContent = statusData.summary.failed;
  document.getElementById('summaryTotal').textContent = statusData.summary.total;

  filterAndRender();
}

function filterAndRender() {
  if (!statusData) return;

  const search = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;

  filteredApps = statusData.apps.filter(app => {
    const matchSearch = !search ||
      app.name.toLowerCase().includes(search) ||
      (app.description && app.description.toLowerCase().includes(search));
    const matchStatus = statusFilter === 'all' || app.status === statusFilter;
    return matchSearch && matchStatus;
  });

  sortApps();
  renderTable();
}

function sortApps() {
  filteredApps.sort((a, b) => {
    let aVal = a[currentSort.key];
    let bVal = b[currentSort.key];

    if (currentSort.key === 'duration') {
      aVal = a.durationMs || 0;
      bVal = b.durationMs || 0;
    }

    if (typeof aVal === 'string') {
      return currentSort.order === 'asc'
        ? aVal.localeCompare(bVal)
        : bVal.localeCompare(aVal);
    }
    return currentSort.order === 'asc' ? aVal - bVal : bVal - aVal;
  });
}

function renderTable() {
  const tbody = document.getElementById('appTableBody');

  if (filteredApps.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h2>æœªæ‰¾åˆ°åº”ç”¨</h2><p>å°è¯•è°ƒæ•´æœç´¢æˆ–ç­›é€‰æ¡ä»¶</p></td></tr>';
    return;
  }

  tbody.innerHTML = filteredApps.map(app => `
    <tr data-app="${app.name}">
      <td><strong>${app.name}</strong><br><small style="color:#858585">${app.description || ''}</small></td>
      <td><span class="status-badge status-${app.status}">${getStatusText(app.status)}</span></td>
      <td><span class="version">${app.bucketVersion}</span></td>
      <td><span class="version">${app.latestVersion}</span></td>
      <td>${app.durationMs ? (app.durationMs / 1000).toFixed(2) + 's' : '-'}</td>
      <td class="actions">
        <button class="btn-sm" onclick="copyInstall('${app.name}')">å¤åˆ¶å®‰è£…</button>
        <button class="btn-sm" onclick="showCheckApp('${app.name}')">æ£€æµ‹</button>
        <button class="btn-sm" onclick="toggleDetail('${app.name}')">è¯¦æƒ…</button>
      </td>
    </tr>
    <tr class="detail-row" id="detail-${app.name}">
      <td colspan="6">
        <div class="detail-content">
          <p><strong>Manifest:</strong> ${app.manifestPath}</p>
          <p><strong>Homepage:</strong> <a href="${app.homepage}" target="_blank" style="color:#4ec9b0">${app.homepage}</a></p>
          <p><strong>æ£€æµ‹æ—¶é—´:</strong> ${new Date(app.checkedAt).toLocaleString('zh-CN')}</p>
          ${app.message ? `<p><strong>æ¶ˆæ¯:</strong> ${app.message}</p>` : ''}
          ${app.log.stdout ? `<pre>${app.log.stdout}</pre>` : ''}
          ${app.log.stderr ? `<pre style="color:#f48771">${app.log.stderr}</pre>` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

function getStatusText(status) {
  const map = { latest: 'âœ“ æœ€æ–°', outdated: 'âš  éœ€æ›´æ–°', failed: 'âœ— å¤±è´¥' };
  return map[status] || status;
}

function copyInstall(appName) {
  const cmd = `scoop install mqbucket/${appName}`;
  navigator.clipboard.writeText(cmd).then(() => showToast('å·²å¤åˆ¶å®‰è£…å‘½ä»¤'));
}

function toggleDetail(appName) {
  const row = document.getElementById(`detail-${appName}`);
  row.classList.toggle('show');
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function reloadData() {
  showToast('æ­£åœ¨é‡æ–°åŠ è½½æ•°æ®...');
  location.reload();
}

function showCheckHelp() {
  document.getElementById('checkModal').classList.add('show');
}

function showCheckApp(appName) {
  const modal = document.getElementById('checkModal');
  const content = modal.querySelector('.modal-content');
  content.innerHTML = `
    <h2>ğŸ” æ£€æµ‹ ${appName}</h2>
    <p>è¦æ£€æµ‹æ­¤åº”ç”¨çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œï¼š</p>
    <pre>pwsh -File scripts/generate-status.ps1 -Application ${appName} -Token "your_token"</pre>
    <p style="margin-top:15px;color:#858585;font-size:13px">
    æ£€æµ‹å®Œæˆåï¼Œç‚¹å‡»"é‡æ–°åŠ è½½æ•°æ®"æŒ‰é’®åˆ·æ–°é¡µé¢ã€‚<br>
    æ³¨æ„ï¼šå•ä¸ªåº”ç”¨æ£€æµ‹çº¦éœ€ 2-5 ç§’ã€‚<br>
    <strong>å»ºè®®ä½¿ç”¨ Token é¿å… API é™æµï¼ˆ60æ¬¡/å°æ—¶ â†’ 5000æ¬¡/å°æ—¶ï¼‰</strong>
    </p>
    <button class="btn-sm" onclick="closeModal()">å…³é—­</button>
  `;
  modal.classList.add('show');
}

function closeModal() {
  document.getElementById('checkModal').classList.remove('show');
}

document.getElementById('searchInput').addEventListener('input', filterAndRender);
document.getElementById('statusFilter').addEventListener('change', filterAndRender);
document.getElementById('sortBy').addEventListener('change', (e) => {
  currentSort.key = e.target.value;
  sortApps();
  renderTable();
});

document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (currentSort.key === key) {
      currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.key = key;
      currentSort.order = 'asc';
    }
    document.querySelectorAll('th.sortable').forEach(t => {
      t.classList.remove('sort-asc', 'sort-desc');
    });
    th.classList.add(`sort-${currentSort.order}`);
    sortApps();
    renderTable();
  });
});

loadStatus();
</script>
</body>
</html>
