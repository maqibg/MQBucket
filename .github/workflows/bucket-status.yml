name: Bucket Status

on:
  schedule:
    # æ¯å¤© UTC 02:00 è¿è¡Œ
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: bucket-status
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: windows-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Scoop
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
            Write-Host "å®‰è£… Scoop..."
            iwr -useb get.scoop.sh -outfile 'install.ps1'
            .\install.ps1 -RunAsAdmin
            Remove-Item install.ps1
          }
          scoop --version

          # è®¾ç½® SCOOP_HOME ç¯å¢ƒå˜é‡
          if (-not $env:SCOOP_HOME) {
            $env:SCOOP_HOME = "$env:USERPROFILE\scoop"
            echo "SCOOP_HOME=$env:SCOOP_HOME" >> $env:GITHUB_ENV
          }

      - name: Generate status.json
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "å¼€å§‹ç”Ÿæˆ status.json..."
          pwsh -File scripts/generate-status.ps1 -BucketDir bucket -OutFile public/status.json

          if (-not (Test-Path public/status.json)) {
            Write-Error "status.json ç”Ÿæˆå¤±è´¥"
            exit 1
          }

          Write-Host "âœ… status.json ç”ŸæˆæˆåŠŸ"
          Get-Content public/status.json -Head 20

      - name: Prepare Pages artifact
        shell: pwsh
        run: |
          Write-Host "å‡†å¤‡ Pages éƒ¨ç½²æ–‡ä»¶..."

          # å¤åˆ¶ bucket-index.html åˆ° public ç›®å½•
          Copy-Item bucket-index.html public/index.html -Force

          # å¤åˆ¶ schema æ–‡ä»¶
          if (Test-Path public/status.schema.json) {
            Write-Host "âœ… Schema æ–‡ä»¶å·²å­˜åœ¨"
          }

          # åˆ—å‡º public ç›®å½•å†…å®¹
          Write-Host "`nğŸ“ Public ç›®å½•å†…å®¹:"
          Get-ChildItem public -Recurse | Format-Table Name, Length

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
